<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>World-cup-visual</title>

    <!-- D3.js -->

    <script src="{{
  url_for('static', filename='js/d3.min.js') }}"></script>

    <script src="{{
  url_for('static', filename='js/d3pie.min.js') }}"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/style.css') }}">
    <!-- Month names -->
    <link href='https://fonts.googleapis.com/css?family=Pacifico' rel='stylesheet' type='text/css'>


</head>

<body>

    <div id="chart"></div>

    <script>
        ////////////////////////////////////////////////////////////
        //////////////////////// Set-up ////////////////////////////
        ////////////////////////////////////////////////////////////

        var screenWidth = window.innerWidth;

        
        var ellipse_koef = 1.1
        var margin = {
                left: 0,
                top: 0,
                right: 0,
                bottom: 0
            },
            width = Math.min(screenWidth, 1000) - margin.left - margin.right,
            height = Math.min(screenWidth, 1000) - margin.top - margin.bottom;
        var outerRadius = width * 0.5 - 120
        var svg = d3.select("#chart").append("svg")
            .attr("width", (width + margin.left + margin.right))
            .attr("height", (height + margin.top + margin.bottom))
            .append("g").attr("class", "wrapper")
            .attr("transform", "translate(" + (width / 2 + margin.left) + "," + (height / 2 + margin.top) + ")");

        function getEllipseCoords(coorX, coorY, translateX, translateY) {
            //console.log(Math.sqrt(ellipse_koef * ellipse_koef * coorY * coorY +  coorX * coorX ))
            //console.log(ellipse_koef * coorX)
            newX = ellipse_koef * coorX / (Math.sqrt(ellipse_koef * ellipse_koef * coorY * coorY + coorX * coorX)) * outerRadius;
            newY = newX * coorY / coorX;
            return [newX, newY]
        }

             
        //Create a color scale
        var colorScale = d3.scale.linear()
            .domain([1, 3.5, 6])
            .range(["#2c7bb6", "#ffffbf", "#d7191c"])
            .interpolate(d3.interpolateHcl);

        //Create an arc function   
        var arc = d3.svg.arc()
            .innerRadius(width * 0.5 - 210)
            .outerRadius(outerRadius);

        //Turn the pie chart 90 degrees counter clockwise, so it starts at the left	
        var pie = d3.layout.pie()
            .startAngle(-180 * Math.PI / 180)
            .endAngle(-180 * Math.PI / 180 + 2 * Math.PI)
            .value(function(d) {
                return d.value;
            })
            .padAngle(.01)
            .sort(null);
   
        
        
        ////////////////////////////////////////////////////////////// 
        ///////////////////// Data &  Scales ///////////////////////// 
        ////////////////////////////////////////////////////////////// 

        //Some random data
           var donutData = [
            {% for d in teams %} {
                "name": "{{d['name']}}",
                "value": {{d['value']}},
                "color": "{{d['color']}}",
                "id_group": "{{d['id_group']}}"         
            },
             {% endfor %}
             {
                "name": "",
                "value": {{space}},
                "color":"none"    
            },     
            {% for d in rounds %} {
                "name": "{{d['name']}}",
                "value": {{d['value']}},
                "color": "{{d['color']}}",
                "id_group": "{{d['id_group']}}"            
            },
             {% endfor %}
             {
                "name": "",
                "value": {{space}},
                 "color":"none"     
            }, 
             {% for d in places %} {
                "name": "{{d['name']}}",
                "value": {{d['value']}},
                "color": "{{d['color']}}" ,
                "id_group": "{{d['id_group']}}"            
            },
             {% endfor %}      
              {
                "name": "",
                "value": {{space}},
                 "color":"none"     
            },
            {% for d in stages %} {
                "name": "{{d['title']}}",
                "value": {{d['value']}},
                "color": "{{d['color']}}" ,
                "id_group": "{{d['id_group']}}"            
            },
            {% endfor %}    
            {
                "name": "",
                "value": {{space}},
                "color":"none"     
            }, 
        
        ];        
                
        ////////////////////////////////////////////////////////////// 
        //////////////////// Create Donut Chart ////////////////////// 
        ////////////////////////////////////////////////////////////// 

        //Create the donut slices and also the invisible arcs for the text 
        svg.selectAll(".donutArcs")
            .data(pie(donutData))
            .enter().append("path")
            .attr("class", "donutArcs")
            .attr("d", arc)

            .style("fill", function(d, i) {
                return "none";

            })
            .each(function(d, i) {
                //Search pattern for everything between the start and the first capital L
                var firstArcSection = /(^.+?)L/;
                var lastArcSection = /L(.*?)Z/;
                console.log(d3.select(this).attr("d"))
                //console.log((width / 2 + margin.left))


                //между М и A -->  преобразуем
                //между A и 0 0, 1 по X увеличивам на K
                //между 0 0,1 и L  преобразуем
            
            
                //M -1.2879629948845253, 221.49625538894287       //первая точка на внешнем радиусе
                //A 221.5, 221.5                                  //внешний радиус
                //0 0,1 -14.203496816146563, 221.04413739837958   //вторая точка на внешнем радиусе
                //L -7.9099938637859095, 131.26188326043044       //первая точка на внутреннем радиусе   
                //A 131.5, 131.5                                  //внутренний радиус
                //0 0,0 -1.2879629948845304, 131.49369243930983Z  //вторая точка на внутреннем радиусе
                var firstDotEx = /M(.*?)A/;
                var radEll = /A(.*?)0 0,1/;
                var secondDotEx = /0 0,1(.*?)L/;
                var firstSmallDotEx  = /L(.*?)A/;
                var radSmallElEx = /A(.*?)0 0,0/
                var secondSmallDotEx = /0 0,0(.*?)Z/;    
                  
     
                //newArc = "M" + newStart + "A" + middleSec + "0 0 0 " + newEnd;
            
            
            
                
                firstLoc = firstDotEx.exec(d3.select(this).attr("d"))[1]
                radLoc = radEll.exec(d3.select(this).attr("d"))[1]
                secLoc = secondDotEx.exec(d3.select(this).attr("d"))[1]

                firstSmallLoc = firstSmallDotEx.exec(d3.select(this).attr("d"))[1]
                secSmallLoc = secondSmallDotEx.exec(d3.select(this).attr("d"))[1]
                radSmallLoc = radSmallElEx.exec(d3.select(this).attr("d"))[1]
            
                var first = firstLoc.split(",");
                newFirst = getEllipseCoords(parseFloat(first[0]), parseFloat(first[1]), 0, 0).join(",")

                var second = secLoc.split(",");
                newLast = getEllipseCoords(parseFloat(second[0]), parseFloat(second[1]), 0, 0).join(",")
                var rad = radLoc.split(",")
                newRad = [ellipse_koef * rad[0], rad[1]].join(",")

                FirstPath = "M" + newFirst + "A" + newRad + "0 0, 1" + newLast 
                ellipseArc = FirstPath + "L" + firstSmallLoc + "A" + radSmallLoc + "0 0,0" + secSmallLoc + "Z"
                console.log("ellipse arc " + ellipseArc)
                
                if(donutData[i]["id_group"]  != 0) {                      
                    textArc = "M" +  newLast + "L" + firstSmallLoc + "Z"			
                }
                else {
                    textArc = "M" + secSmallLoc + "L" + newFirst + "Z"
                }
               
			svg.append("path")
				.attr("class", "hiddenDonutArcs")
				.attr("id", "donutArc"+i)
				.attr("d", textArc)
				.style("fill", "none");
			
			svg.append("path")
				.attr("class", "ellipse")
				.attr("id", "donutArc"+i)
				.attr("d", ellipseArc)
				.style("fill", donutData[i]["color"]);
            });

        //Append the label names on the outside
        svg.selectAll(".donutText")
            .data(pie(donutData))
            .enter().append("text")
            .style("font-size", "16px") 
            .attr("class", "donutText")

            //Move the labels below the arcs for those slices with an end angle greater than 90 degrees
            //.attr("dy", function(d, i) {
              //  return (d.endAngle > 90 * Math.PI / 180 ? 18 : -11);
            //})

            .append("textPath")
            .attr("startOffset", "50%")

            .attr("xlink:href", function(d, i) {
                return "#donutArc" + i;
            })
             
            //.attr("xlink:href",function(d) {return d.data.image;})
            .text(function(d) {
                return d.data.name;
            });

    </script>

</body>

</html>
