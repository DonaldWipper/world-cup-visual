update games g
join teams_wc as w1
     on w1.id = g.awayTeamId 
     
join teams_wc as w2 
     on w2.id = g.homeTeamId 
 
join games_fifa as gl
     on gl.awayTeam = w1.name
     and gl.homeTeam = w2.name    
 
left join places as p
     on LOWER(gl.stadium) like CONCAT('%',lower(p.short_name),'%')
set g.placeId = 10
where g.competitionId = 467  
      and g.placeId is null
      
      
update games  g
join standings s
     on g.awayTeamId = s.teamId
     and g.competitionId = s.competitionId
join stages s2
     on s2.title = concat("Group ",s.group_)     
 set g.id_stage = s2.id    
     

select *
join teams_wc as w1
     on w1.id = g.awayTeamId 
     
join teams_wc as w2 
     on w2.id = g.homeTeamId 
 
join games_fifa as gl
     on gl.awayTeam = w1.name
     and gl.homeTeam = w2.name    
 


where g.competitionId = 467  


      and g.placeId is null
      
      
select *
from games g
join matches m
    on g.awayTeamId = m.awayTeamId
    and g.homeTeamId = m.homeTeamId
    and g.date = m.date
where m.extraTimeHomeGoals is not null
      or m.extraTimeAwayGoals is not null 
      or m.penaltyShootoutHomeGoals  is not null
      or m.penaltyShootoutAwayGoals is not null

      
update teams_wc tw
join 
(select distinct teamHome, shortHomeTeam
from games_fifa_all
union 
select distinct teamAway, shortAwayTeam
from games_fifa_all
) as X
   on x.teamHome = tw.name
 set tw.shortName =  X.shortHomeTeam
 where tw.shortName is null


update games_fifa_all_back b
join tournaments t
     on t.year = cast(date as nchar(4))
set b.competionId = t.id




 
select  *
from games g
join teams_wc w
	 on g.awayTeamId = w.id

join games_fifa_all a
	 on cast(g.date as nchar(10))  = cast(a.date as nchar(10))
     and a.teamHomeIdGlobal = g.homeTeamId
     
where shortName is null


update games_fifa_all a
join  teams_wc w
    on a.shortHomeTeam = w.shortName
set a.teamHomeIdGlobal = w.id





update games g
join teams_wc w
	 on g.awayTeamId = w.id

join games_fifa_all a
	 on cast(g.date as nchar(10))  = cast(a.date as nchar(10))
     and a.teamHomeIdGlobal = g.homeTeamId
set w.shortName = shortAwayTeam     
where shortName is null




update games g
join teams_wc w
	 on g.homeTeamId = w.id

join games_fifa_all a
	 on cast(g.date as nchar(10))  = cast(a.date as nchar(10))
     and a.teamAwayIdGlobal = g.awayTeamId
set w.shortName = shortHomeTeam     
where shortName is null


update games_fifa_all a 

join  games g
	 on cast(g.date as nchar(10))  = cast(a.date as nchar(10))
     and g.goalsHomeTeam = a.goalsHomeTeam
     and g.goalsAwayTeam = a.goalsAwayTeam

left join teams_wc th
    on th.id = g.homeTeamId
    
left join teams_wc ta
    on ta.id = g.awayTeamId

set teamAwayIdGlobal = ta.id      
    
where (a.teamHomeIdGlobal is null and (a.teamAwayIdGlobal = ta.id))
	   or (a.teamAwayIdGlobal is null  and (a.teamHomeIdGlobal = th.id)) 



      


SET @rank=12;
insert into places (stadium, short_name, city, id, competitionId)
select stadium, short_name, city,  @rank:=@rank+1 AS id, competionId
from(
select distinct stadium, replace(lower(stadium), ' ', '') as short_name, city, competionId
from games_fifa_all a 
) as A




set @rank = 0;
select distinct group_name, competionId,  @rank:=@rank+1 AS pos
from games_fifa_all
where competionId = 409


set @rank = 0;


insert into stages (title, competitionId, pos, id)
select group_name, competionId,  @rank:=@rank+1 AS pos, @id:=@id+1
from(
  select distinct group_name, competionId
  from games_fifa_all
  where competionId = 365
) as A



set @rank = 0;
set @id = 155;

      
insert into stages (title, competitionId, pos, id)
select group_name, competionId,  @rank:=@rank+1 AS pos, @id:=@id+1
from(
  select distinct group_name, competionId
  from games_fifa_all
  where competionId = 406
) as A


set @rank = 20;

insert into rounds(start_at, end_at, competitionId, title, id)
select start_at, end_at, competionId, title,  @rank:=@rank+1
from (
select cast(MIN(date) as nchar(10)) start_at, cast(MAX(date) as nchar(10)) end_at, competionId, group_name as title
from games_fifa_all
group by competionId, group_name  
) AS A  



update games_fifa_all a
join places p 
    on p.stadium = a.stadium
    and a.competionId = p.competitionId
set a.placeId = p.id
where a.placeId is null



update games_fifa_all a
join stages s 
    on s.title = a.group_name
    and a.competionId = s.competitionId
set a.id_stage = s.id
where a.id_stage is null



update games_fifa_all a
join  teams_wc w
    on a.shortHomeTeam = w.shortName
set a.teamHomeIdGlobal = w.id
where a.teamHomeIdGlobal  is null

update games_fifa_all a
join  teams_wc w
    on a.shortAwayTeam = w.shortName
set a.teamAwayIdGlobal = w.id
where a.teamAwayIdGlobal  is null




update games_fifa_all
set  penaltyShootoutHomeGoals = NULL,
     penaltyShootoutAwayGoals = NULL
where reasonwin != ''
      and penaltyShootoutHomeGoals = 0
      and penaltyShootoutAwayGoals = 0





insert into games(competitionId, goalsHomeTeam, placeId, awayTeamId, goalsAwayTeam, status, homeTeamId, date,  id_stage, extraTimeHomeGoals, extraTimeAwayGoals, penaltyShootoutHomeGoals, penaltyShootoutAwayGoals)
select competionId, goalsHomeTeam, placeId, teamAwayIdGlobal, goalsAwayTeam, 'FINISHED', 
       teamHomeIdGlobal, datetime, id_stage, extraTimeHomeGoals, extraTimeAwayGoals, penaltyShootoutHomeGoals, penaltyShootoutAwayGoals
from games_fifa_all




update games_fifa_all  g
join teams_wc t
    on t.shortName = shortAwayTeam
set g.teamAway = t.name    
where teamAwayIdGlobal = 757


insert into games(competitionId, goalsHomeTeam, placeId, awayTeamId, goalsAwayTeam, status, homeTeamId, date,  id_stage, extraTimeHomeGoals, extraTimeAwayGoals, penaltyShootoutHomeGoals, penaltyShootoutAwayGoals)
select competionId, goalsHomeTeam, placeId, teamAwayIdGlobal, goalsAwayTeam, 'FINISHED', 
       teamHomeIdGlobal, datetime, id_stage, extraTimeHomeGoals, extraTimeAwayGoals, penaltyShootoutHomeGoals, penaltyShootoutAwayGoals
from games_fifa_all
where competionId = 406
group by competionId, goalsHomeTeam, placeId, teamAwayIdGlobal, goalsAwayTeam, 'FINISHED', 
       teamHomeIdGlobal, datetime, id_stage, extraTimeHomeGoals, extraTimeAwayGoals, penaltyShootoutHomeGoals, penaltyShootoutAwayGoals

update stages
set pos = case when title = 'Final' then 13
               when title = 'Match for third place' then 12
               when title = 'Semi-finals' then 11
               when title = 'Quarter-finals' then 10
               when title = 'Round of 16' then 9
                   else pos
         end 


update games_fifa_all a
join stages s 
    on s.title = a.group_name
    and a.competionId = s.competitionId
set a.id_stage = s.pos
where a.id_stage != s.pos

